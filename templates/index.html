<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="description" content="Генератор маршрутов IPv4 и IPv6 для роутеров Keenetic/Netcraze. Скачивайте .bat файлы для автоматической настройки маршрутов.">
    <title>KRoute</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/img/favicon-32.ico">

    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- Manifest -->
    <link rel="manifest" href="/static/manifest.json">

    <!-- Highlight.js -->
    <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.11.1/styles/github.min.css">
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.11.1/highlight.min.js"></script>
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.11.1/languages/dos.min.js"></script>
    <script>
      hljs.highlightAll();
    </script>

    <!-- Service Worker -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/service-worker.js')
            .then(reg => console.log('Service Worker registered', reg))
            .catch(err => console.log('Service Worker failed', err));
        });
      }
    </script>
</head>
<body>
<div class="container">

  {% with messages = get_flashed_messages(category_filter=["warning"]) %}
    {% if messages %}
      <div class="flash-messages">
        {% for msg in messages %}
          <div class="flash flash-warning">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="header">
    <h2><span class="keen">k</span><span class="route">route</span></h2>
  </div>

  <form id="routeForm" method="post">
    <label for="domains">Домены (по одному в строке):</label>
    <textarea name="domains" id="domains">{{ domains }}</textarea>

    <label for="route_type">Тип маршрута:</label>
    <select name="route_type" id="route_type">
      <option value="host" {% if route_type=="host" %}selected{% endif %}>Host (узел)</option>
      <option value="network" {% if route_type=="network" %}selected{% endif %}>Network (сеть)</option>
      <option value="default" {% if route_type=="default" %}selected{% endif %}>Default (по умолчанию)</option>
    </select>

    <div class="row">
      <div class="field-group">
        <label for="gateway">Шлюз (gateway):</label>
        <input type="text" name="gateway" id="gateway" value="{{ gateway }}">
      </div>

      <div id="networkSettings">
        <div class="field-group">
          <label for="mask_ipv4">Маска сети IPv4 (по умолчанию 255.255.255.0):</label>
          <input type="text" name="mask_ipv4" id="mask_ipv4" value="{{ mask_ipv4 }}">
        </div>
        <div class="field-group">
          <label for="prefix_ipv6">Префикс сети IPv6 (по умолчанию /64):</label>
          <input type="text" name="prefix_ipv6" id="prefix_ipv6" value="{{ prefix_ipv6 }}">
        </div>
      </div>
    </div>

    <div class="checkbox-row" id="ipChecks">
      <label class="check">
        <input type="checkbox" id="ipv4" name="ipv4" {% if ipv4 %}checked{% endif %}>
        <span>IPv4-маршруты</span>
      </label>
      <label class="check">
        <input type="checkbox" id="ipv6" name="ipv6" {% if ipv6 %}checked{% endif %}>
        <span>IPv6-маршруты</span>
      </label>
      <div id="hint" class="hint" role="alert" aria-live="polite">
        Выберите хотя бы один стек (IPv4 или IPv6), иначе маршруты не сгенерируются.
      </div>
      <label class="check">
        <input type="checkbox" id="add_comment" name="add_comment" {% if add_comment %}checked{% endif %}>
        <span>Добавлять комментарии с адресом ресурса в правило</span>
      </label>
    </div>

    <script>
    function toggleNetworkSettings() {
      const routeType = document.getElementById('route_type').value;
      const networkSettings = document.getElementById('networkSettings');
      if (routeType === 'network') {
        networkSettings.style.display = 'flex';
      } else {
        networkSettings.style.display = 'none';
      }
    }
    
    window.addEventListener('load', toggleNetworkSettings);
    document.getElementById('route_type').addEventListener('change', toggleNetworkSettings);
    </script>
      
    <div class="buttons">
      <button type="submit" name="action" value="generate">Сгенерировать</button>
      {% if result_v4 or result_v6 %}
        <button type="submit" name="action" value="download">Скачать .bat</button>
      {% endif %}
    </div>
  </form>

  {% if result_v4 %}
    <h3>Сгенерированные строки (IPv4):</h3>
    <pre><code class="language-dos" id="result_v4">{{ result_v4 }}</code></pre>
    <button class="copy" onclick="copyToClipboard('result_v4')">Копировать IPv4</button>
  {% endif %}

  {% if result_v6 %}
    <h3>Сгенерированные строки (IPv6):</h3>
    <pre><code class="language-dos" id="result_v6">{{ result_v6 }}</code></pre>
    <button class="copy" onclick="copyToClipboard('result_v6')">Копировать IPv6</button>
  {% endif %}

</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}

function copyToClipboard(id) {
  const el = document.getElementById(id);
  if (!el) { showToast('Нечего копировать'); return; }
  const text = el.innerText.trim();
  if (!text) { showToast('Пусто'); return; }

  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(text).then(() => showToast('Скопировано'))
      .catch(() => fallbackCopy(text));
  } else {
    fallbackCopy(text);
  }
}

function fallbackCopy(text) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.opacity = '0';
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  try { document.execCommand('copy'); showToast('Скопировано'); }
  catch (e) { alert('Не удалось скопировать: ' + e); }
  document.body.removeChild(ta);
}

const form = document.getElementById('routeForm');
form.addEventListener('submit', function(e) {
  const v4 = document.getElementById('ipv4').checked;
  const v6 = document.getElementById('ipv6').checked;
  const addComments = document.getElementById('add_comments').checked;
  if (!v4 && !v6) {
    e.preventDefault();
    const hint = document.getElementById('hint');
    hint.classList.add('show');
    document.getElementById('ipChecks').classList.add('error');
    showToast('Выберите IPv4 или IPv6');
    return false;
  }

  localStorage.setItem("domains", document.getElementById("domains").value);
  localStorage.setItem("gateway", document.getElementById("gateway").value);
  localStorage.setItem("mask_ipv4", document.getElementById("mask_ipv4").value);
  localStorage.setItem("prefix_ipv6", document.getElementById("prefix_ipv6").value);
  localStorage.setItem("ipv4", v4);
  localStorage.setItem("ipv6", v6);
  localStorage.setItem("add_comments", addComments);
  localStorage.setItem("route_type", document.getElementById("route_type").value);
});

window.addEventListener('load', () => {
  if (localStorage.getItem("domains")) document.getElementById("domains").value = localStorage.getItem("domains");
  if (localStorage.getItem("gateway")) document.getElementById("gateway").value = localStorage.getItem("gateway");
  if (localStorage.getItem("mask_ipv4")) document.getElementById("mask_ipv4").value = localStorage.getItem("mask_ipv4");
  if (localStorage.getItem("prefix_ipv6")) document.getElementById("prefix_ipv6").value = localStorage.getItem("prefix_ipv6");

  const st4 = localStorage.getItem("ipv4");
  const st6 = localStorage.getItem("ipv6");
  const stComments = localStorage.getItem("add_comments");
  if (st4 !== null) document.getElementById("ipv4").checked = (st4 === "true");
  if (st6 !== null) document.getElementById("ipv6").checked = (st6 === "true");
  if (stComments !== null) document.getElementById("add_comments").checked = (stComments === "true");

  const rt = localStorage.getItem("route_type");
  if (rt) document.getElementById("route_type").value = rt;

  ['ipv4','ipv6'].forEach(id => {
    document.getElementById(id).addEventListener('change', () => {
      document.getElementById('hint').classList.remove('show');
      document.getElementById('ipChecks').classList.remove('error');
    });
  });
});
</script>
</body>
</html>
