<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keenroute</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Highlight.js для подсветки кода -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>window.addEventListener('DOMContentLoaded', () => hljs.highlightAll());</script>

    <!-- Service Worker для PWA -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('{{ url_for('static', filename='service-worker.js') }}')
            .then(reg => console.log('Service Worker registered', reg))
            .catch(err => console.log('Service Worker failed', err));
        });
      }
    </script>
</head>
<body>
<div class="container">
  <div class="header">
    <!--<img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" class="logo"-->
    <h2><span class="keen">Keen</span><span class="route">route</span></h2>
  </div>

  <form id="routeForm" method="post">
    <label for="domains">Домены (по одному в строке):</label>
    <textarea name="domains" id="domains">{{ domains }}</textarea>

    <label for="route_type">Тип маршрута:</label>
    <select name="route_type" id="route_type">
      <option value="host" {% if route_type=="host" %}selected{% endif %}>Host (узел)</option>
      <option value="network" {% if route_type=="network" %}selected{% endif %}>Network (сеть)</option>
      <option value="default" {% if route_type=="default" %}selected{% endif %}>Default (по умолчанию)</option>
    </select>

    <div class="row">
      <div class="field-group">
        <label for="gateway">Шлюз (gateway):</label>
        <input type="text" name="gateway" id="gateway" value="{{ gateway }}">
      </div>
      <div class="field-group">
        <label for="mask">Маска сети (авто / по умолчанию):</label>
        <input type="text" name="mask" id="mask" value="{{ mask }}">
      </div>
    </div>

    <div class="checkbox-row" id="ipChecks">
      <label class="check">
        <input type="checkbox" id="ipv4" name="ipv4" {% if ipv4 is not defined %}checked{% elif ipv4 %}checked{% endif %}>
        <span>IPv4-маршруты</span>
      </label>
      <label class="check">
        <input type="checkbox" id="ipv6" name="ipv6" {% if ipv6 %}checked{% endif %}>
        <span>IPv6-маршруты</span>
      </label>
      <div id="hint" class="hint" role="alert" aria-live="polite">
        Выберите хотя бы один стек (IPv4 или IPv6), иначе маршруты не сгенерируются.
      </div>
    </div>

    <div class="buttons">
      <button type="submit" name="action" value="generate">Сгенерировать</button>
      {% if result_v4 or result_v6 %}
      <button type="submit" name="action" value="download">Скачать .bat</button>
      {% endif %}
    </div>
  </form>

  {% if result_v4 %}
    <h3>Сгенерированные строки (IPv4):</h3>
    <pre><code class="language-dos" id="result_v4">{{ result_v4 }}</code></pre>
    <button class="copy" onclick="copyToClipboard('result_v4')">Копировать IPv4</button>
  {% endif %}

  {% if result_v6 %}
    <h3>Сгенерированные строки (IPv6):</h3>
    <pre><code class="language-dos" id="result_v6">{{ result_v6 }}</code></pre>
    <button class="copy" onclick="copyToClipboard('result_v6')">Копировать IPv6</button>
  {% endif %}
</div>

<!-- Toast уведомление -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}

function copyToClipboard(id) {
  const el = document.getElementById(id);
  if (!el) { showToast('Нечего копировать'); return; }
  const text = el.innerText.trim();
  if (!text) { showToast('Пусто'); return; }

  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(text).then(() => showToast('Скопировано'))
      .catch(() => fallbackCopy(text));
  } else {
    fallbackCopy(text);
  }
}

function fallbackCopy(text) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.opacity = '0';
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  try { document.execCommand('copy'); showToast('Скопировано'); }
  catch (e) { alert('Не удалось скопировать: ' + e); }
  document.body.removeChild(ta);
}

// Проверка, чтобы хотя бы один чекбокс был отмечен
const form = document.getElementById('routeForm');
form.addEventListener('submit', function(e) {
  const v4 = document.getElementById('ipv4').checked;
  const v6 = document.getElementById('ipv6').checked;
  if (!v4 && !v6) {
    e.preventDefault();
    const hint = document.getElementById('hint');
    hint.classList.add('show');
    document.getElementById('ipChecks').classList.add('error');
    showToast('Выберите IPv4 или IPv6');
    return false;
  }

  localStorage.setItem("domains", document.getElementById("domains").value);
  localStorage.setItem("gateway", document.getElementById("gateway").value);
  localStorage.setItem("mask", document.getElementById("mask").value);
  localStorage.setItem("ipv4", v4);
  localStorage.setItem("ipv6", v6);
  localStorage.setItem("route_type", document.getElementById("route_type").value);
});

// Восстановление состояния формы
window.addEventListener('load', () => {
  if (localStorage.getItem("domains")) document.getElementById("domains").value = localStorage.getItem("domains");
  if (localStorage.getItem("gateway")) document.getElementById("gateway").value = localStorage.getItem("gateway");
  if (localStorage.getItem("mask")) document.getElementById("mask").value = localStorage.getItem("mask");

  const st4 = localStorage.getItem("ipv4");
  const st6 = localStorage.getItem("ipv6");
  if (st4 !== null) document.getElementById("ipv4").checked = (st4 === "true");
  if (st6 !== null) document.getElementById("ipv6").checked = (st6 === "true");

  const rt = localStorage.getItem("route_type");
  if (rt) document.getElementById("route_type").value = rt;

  // убираем подсветку ошибки при изменении чекбоксов
  ['ipv4','ipv6'].forEach(id => {
    document.getElementById(id).addEventListener('change', () => {
      document.getElementById('hint').classList.remove('show');
      document.getElementById('ipChecks').classList.remove('error');
    });
  });
});
</script>
</body>
</html>
