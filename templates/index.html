<!doctype html>
<html>
<head>
    <title>Keenroute</title>
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('{{ url_for('static', filename='service-worker.js') }}')
            .then(reg => console.log('Service Worker registered', reg))
            .catch(err => console.log('Service Worker failed', err));
        });
      }
    </script>
</head>
<body>
<div class="container">
  <h2>Keenroute</h2>
  <form method="post" onsubmit="saveForm()">
    <label>Домены (по одному в строке):</label>
    <textarea name="domains" id="domains">{{ domains }}</textarea>

    <label>Тип маршрута:</label>
    <select name="route_type">
      <option value="host" {% if route_type=="host" %}selected{% endif %}>Host (узел)</option>
      <option value="network" {% if route_type=="network" %}selected{% endif %}>Network (сеть)</option>
      <option value="default" {% if route_type=="default" %}selected{% endif %}>Default (по умолчанию)</option>
    </select>

    <div class="row">
      <div>
        <label>Шлюз (gateway):</label>
        <input type="text" name="gateway" id="gateway" value="{{ gateway }}">
      </div>
      <div>
        <label>Маска сети (авто / по умолчанию):</label>
        <input type="text" name="mask" id="mask" value="{{ mask }}">
      </div>
    </div>

    <div class="checkbox-row">
      <label><input type="checkbox" id="ipv6" name="ipv6" {% if ipv6 %}checked{% endif %}> Включить IPv6</label>
    </div>

    <div class="buttons">
      <button type="submit" name="action" value="generate">Сгенерировать</button>
      {% if result_v4 or result_v6 %}
      <button type="submit" name="action" value="download">Скачать .bat</button>
      {% endif %}
    </div>
  </form>

  {% if result_v4 %}
  <h3>IPv4 маршруты:</h3>
  <pre id="result_v4">{{ result_v4|safe }}</pre>
  <button class="copy-btn" onclick="copyToClipboard('result_v4')">Скопировать IPv4</button>
  {% endif %}

  {% if result_v6 %}
  <h3>IPv6 маршруты:</h3>
  <pre id="result_v6">{{ result_v6|safe }}</pre>
  <button class="copy-btn" onclick="copyToClipboard('result_v6')">Скопировать IPv6</button>
  {% endif %}
</div>

<script>
function copyToClipboard(id) {
  const text = document.getElementById(id).innerText.trim();
  navigator.clipboard.writeText(text).then(() => alert("Скопировано!"));
}
function saveForm() {
  localStorage.setItem("domains", document.getElementById("domains").value);
  localStorage.setItem("gateway", document.getElementById("gateway").value);
  localStorage.setItem("mask", document.getElementById("mask").value);
  localStorage.setItem("ipv6", document.querySelector("input[name='ipv6']").checked);
  localStorage.setItem("route_type", document.querySelector("select[name='route_type']").value);
}
window.onload = function() {
  if (localStorage.getItem("domains")) document.getElementById("domains").value = localStorage.getItem("domains");
  if (localStorage.getItem("gateway")) document.getElementById("gateway").value = localStorage.getItem("gateway");
  if (localStorage.getItem("mask")) document.getElementById("mask").value = localStorage.getItem("mask");
  if (localStorage.getItem("ipv6") === "true") document.querySelector("input[name='ipv6']").checked = true;
};
</script>
</body>
</html>
